import{r as h,a as ne,j as e,b as k,u as oe,d as ie}from"./main-d83a2d54.js";import{A as H,I as re,b as ce,R as le,L as de}from"./Layout-577747f1.js";import{I as J,_ as B}from"./index-f8951119.js";import{M as v}from"./Modal-65a1bf93.js";import{B as M}from"./Button-1919881f.js";import{B as me,D as ue}from"./DrawerContent-40b60b70.js";import{S as he,P as pe}from"./PaginationControls-57af5ba1.js";import{A as xe,D as fe,C as ge,a as be,F as je,P as ye}from"./Payments-1710ea42.js";import{l as z}from"./lodash-078c39ae.js";import{f as K}from"./formatting-345d2430.js";import"./assertThisInitialized-3be3daa4.js";import"./removeClass-63ddb724.js";import"./MultipleUpload-8b6ed96d.js";import"./search-6e1e00a5.js";import"./index-bf5f15db.js";import"./Button-d3e3765c.js";import"./index-ab81bb2e.js";const we=({show:i,handleClose:j,leaseData:p})=>{const[d,c]=h.useState(!1),{data:r,post:y}=ne({leaseId:p.lease_id}),x=()=>{y(reverseUrl("delete_lease"),{onStart:()=>{c(!0)},onSuccess:g=>{B.success(JSON.stringify("Lease terminated successfully")),c(!1)},onError:g=>{B.error("Something went wrong! Please try again"),c(!1)},onFinish:()=>{j()}})};return e.jsxs(v,{show:i,onHide:j,size:"md",backdrop:"static",centered:!0,children:[e.jsx(v.Header,{closeButton:!0,className:"h4 bg-info text-white text-center text-uppercase",children:"Confirm Lease Termination"}),e.jsxs(v.Body,{className:"p-4 d-flex justify-content-between align-items-center gap-4",children:[e.jsx(J,{}),e.jsxs("p",{className:"my-3 text-center",children:["Are you sure you want to terninate lease for ",p.name,"? This action cannot be undone."]})]}),e.jsxs(v.Footer,{className:"p-4 d-flex justify-content-end gap-4",children:[e.jsxs(M,{onClick:j,variant:"secondary",children:[e.jsx("i",{className:"material-icons",children:"cancel"}),"Cancel"]}),e.jsxs(M,{onClick:x,variant:"danger",children:[e.jsx("i",{className:"material-icons",children:"done"}),"Delete"]})]})]})},_e=we;function Ne({clientViewProps:{showModal:i,hideClientView:j,data:p,error:d,isLoading:c,clientId:r,refreshClientViewData:y,lease:x}}){const g=!p;return e.jsx(e.Fragment,{children:e.jsxs(v,{show:i,onHide:j,fullscreen:!0,contentClassName:"custom-bg-whitesmoke",children:[e.jsx(v.Header,{className:"p-0",children:e.jsxs("div",{className:"w-100 p-2 text-center bg-info position-relative",children:[e.jsx("h4",{className:"text-white",children:c||d||g?"Client View":p.tenantName}),e.jsx("button",{type:"button",onClick:j,className:"btn position-absolute top-0 end-0 h-100 d-flex align-items-center text-white",children:e.jsx("i",{className:"material-icons fs-3 px-4",children:"close"})})]})}),e.jsx(v.Body,{children:e.jsxs("div",{className:"position-relative custom-mn-h-5",children:[c&&e.jsxs("div",{className:"text-center position-absolute top-50 start-50 translate-middle",children:[e.jsx("div",{className:"spinner-border text-info spinner-border-md",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})}),e.jsx("p",{children:"Loading...please wait"})]}),d&&e.jsxs("div",{className:"text-center text-danger position-absolute top-50 start-50 translate-middle",children:[e.jsx("p",{children:e.jsx("i",{className:"material-icons fs-1",children:"warning"})}),e.jsxs("p",{children:["Error: ",z.truncate(d,{length:500})]})]}),!(c||d||g)&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"row row-cols-3 align-items-stretch",children:[e.jsxs("div",{className:"col p-1",children:[e.jsx(xe,{data:p.agedAnalysis}),e.jsx(fe,{data:p.debtorIntelligence,clientId:r}),e.jsx(ge,{data:p.contactDetails,clientId:r})]}),e.jsx("div",{className:"col p-1",children:e.jsx(be,{messages:p.communicationHistory,clientId:r,lease:x})}),e.jsxs("div",{className:"col p-1",children:[e.jsx(je,{data:p.forecastInflows}),e.jsx(ye,{clientId:r,paymentPlans:p.paymentPlans,refreshClientViewData:y,leaseId:x.lease_id})]})]})})]})})]})})}function ve(){const[i,j]=h.useState(!1),[p,d]=h.useState(null),[c,r]=h.useState(""),[y,x]=h.useState(!1),[g,w]=h.useState(null);function C(s){w(s),j(!0),x(!0),r(""),k(reverseUrl("client_details"),{params:{lease_id:s.lease_id}}).then(a=>{const m={tenantName:s.name,agedAnalysis:{oneTwentyDays:a.data.aged_analysis["120_days_plus"],ninetyDays:a.data.aged_analysis["90_days"],sixtyDays:a.data.aged_analysis["60_days"],thirtyDays:a.data.aged_analysis["30_days"],current:a.data.aged_analysis.current},contactDetails:{contactPerson:`${a.data.client.firstname} ${a.data.client.surname}`,smsNumber:a.data.client.sms_number,otherNumbers:a.data.other_numbers?a.data.client.other_numbers.join(", "):"",emailAddress:a.data.client.email,address:a.data.client.address},paymentPlans:a.data.payment_plans.map(f=>({id:f.id,person:f.spoke_with,date:f.expected_pay_date,amount:f.amount})),communicationHistory:a.data.communication_history.map(f=>({text:f.message,timestamp:f.created_at,user:f.user_name,actionDone:f.action_done?f.action_done:null,communicationType:f.type})),debtorIntelligence:Object.values(a.data.debtor_intelligence).length&&Object.values(a.data.debtor_intelligence).every(Boolean)?{text:a.data.debtor_intelligence.note,timestamp:a.data.debtor_intelligence.updated_at,user:a.data.debtor_intelligence.user_name}:null,forecastInflows:{zeroToSevenDays:a.data.forecast_inflows["0-7"],eightToFourteenDays:a.data.forecast_inflows["8-14"],fourteenToTwentyOneDays:a.data.forecast_inflows["14-21"],twentyOnePlusDays:a.data.forecast_inflows["21+"],total:a.data.forecast_inflows.total}};console.log({res:a,resData:m}),d(m),r(""),x(!1)}).catch(a=>{a instanceof H?r(a.response.status===500?`Error: ${a.response.statusText}`:JSON.stringify(a.response.data)):r(a),d(null),x(!1)})}function _(){console.log("refreshing.."),x(!0),r(""),k(reverseUrl("client_details"),{params:{lease_id:g.lease_id}}).then(s=>{const a={tenantName:g.name,agedAnalysis:{oneTwentyDays:s.data.aged_analysis["120_days_plus"],ninetyDays:s.data.aged_analysis["90_days"],sixtyDays:s.data.aged_analysis["60_days"],thirtyDays:s.data.aged_analysis["30_days"],current:s.data.aged_analysis.current},contactDetails:{contactPerson:`${s.data.client.firstname} ${s.data.client.surname}`,smsNumber:s.data.client.sms_number,otherNumbers:s.data.other_numbers?s.data.client.other_numbers.join(", "):"",emailAddress:s.data.client.email,address:s.data.client.address},paymentPlans:s.data.payment_plans.map(m=>({id:m.id,person:m.spoke_with,date:m.expected_pay_date,amount:m.amount})),communicationHistory:s.data.communication_history.map(m=>({text:m.message,timestamp:m.created_at,user:m.user_name,actionDone:m.action_done?m.action_done:null,communicationType:m.type})),debtorIntelligence:Object.values(s.data.debtor_intelligence).length&&Object.values(s.data.debtor_intelligence).every(Boolean)?{text:s.data.debtor_intelligence.note,timestamp:s.data.debtor_intelligence.updated_at,user:s.data.debtor_intelligence.user_name}:null,forecastInflows:{zeroToSevenDays:s.data.forecast_inflows["0-7"],eightToFourteenDays:s.data.forecast_inflows["8-14"],fourteenToTwentyOneDays:s.data.forecast_inflows["14-21"],twentyOnePlusDays:s.data.forecast_inflows["21+"],total:s.data.forecast_inflows.total}};d(a),r(""),x(!1)}).catch(s=>{s instanceof H?r(s.response.status===500?`Error: ${s.response.statusText}`:JSON.stringify(s.response.data)):r(s),d(null),x(!1)})}function L(){j(!1)}return{showModal:i,openClientView:C,hideClientView:L,data:p,error:c,isLoading:y,clientId:g?g.id:null,refreshClientViewData:_,lease:g}}function Ce(i){const{props:{error:j},url:p}=oe();let d=new URL(p).searchParams.get("color");const[c,r]=h.useState({}),[y,x]=h.useState([]),[g,w]=h.useState(!1),[C,_]=h.useState(!1),[L,s]=h.useState(0),[a,m]=h.useState(!1),[f,E]=h.useState(d?"rent-owing-des":"default"),$=ve(),[A,T]=h.useState(!1),[I,P]=h.useState(!1);h.useEffect(()=>{k.post(reverseUrl("open_subscription")).then(t=>{x(t.data)}).catch(t=>{})},[x]);const F=document.getElementById("hide-footer");switch(h.useEffect(()=>(F!==null&&document.getElementById("footer").classList.add("d-none"),()=>{F!==null&&document.getElementById("footer").classList.remove("d-none")}),[F]),d){case"orange":d="warning";break;case"black":d="black";break;case"red":d="red";break;case"green":d="success";break;case"#991b1b":d="danger";break}j&&B.error(j);function R(t){E(t.target.value)}let N=t=>t;function O(t){console.log(t),k.post(reverseUrl("write-off"),{lease_id:t.lease_id}).then(n=>{console.log(n),ie.Inertia.reload()}).catch(n=>{var l,S;console.log(n);const u=(S=(l=n==null?void 0:n.response)==null?void 0:l.data)!=null&&S.errors?JSON.stringify(n.response.data.errors):JSON.stringify(n);B.error(`An error occured:
`+z.truncate(u,{length:200}))})}switch(f){case"rent-owing-asc":N=t=>{const n=[...t];return n.sort((u,l)=>u.owing_amount-l.owing_amount),n};break;case"rent-owing-des":N=t=>{const n=[...t];return n.sort((u,l)=>l.owing_amount-u.owing_amount),n};break;case"color-asc":N=t=>{const n={};t.forEach(l=>{l.color in n?n[l.color].push(l):n[l.color]=[l]});let u=[];return Object.keys(n).forEach(l=>{u=u.concat(n[l].sort((S,U)=>S.owing_amount-U.owing_amount))}),u};break;case"color-des":N=t=>{const n={};t.forEach(l=>{l.color in n?n[l.color].push(l):n[l.color]=[l]});let u=[];return Object.keys(n).forEach(l=>{u=u.concat(n[l].sort((S,U)=>U.owing_amount-S.owing_amount))}),u};break;default:N=t=>t;break}const[b,V]=h.useState({});h.useEffect(()=>{k.get(reverseUrl("rate_setup")).then(t=>{var u;const n=(u=t==null?void 0:t.data)==null?void 0:u.currency_settings;if(!n)throw new Error("failed to fetch currency settings");V(n)}).catch(t=>{console.log(t)})},[]);const o=Object.keys(b).length===0,D=o?"":`${b==null?void 0:b.base_currency.toUpperCase()} ${K(i?i.reduce((t,n)=>{let u=n.owing_amount;return n.currency.trim().toLowerCase()!==(b==null?void 0:b.base_currency.trim().toLowerCase())&&(u=n.owing_amount/(b==null?void 0:b.current_rate)),t+u},0):0).replace("$","")}`,W=!o&&i&&i.find(t=>t.currency.trim().toLowerCase()!=="usd")?`${b.base_currency.toUpperCase()} 1 = ${b.currency.toUpperCase()} ${b.current_rate}`:"",q=i!=null&&i.length?i.reduce((t,n)=>n.terminated?t:t+=1,0):0;function G(t){r(t),_(!0)}function Q(){_(!1),r({})}function X(t){r(t),w(!0)}function Y(){w(!1),r({})}function Z(t){r(t),T(!0)}function ee(){r({}),T(!1)}function te(t){r(t),P(!0)}function se(){r({}),P(!1)}function ae(t,n={isCompany:!1}){t.is_company||n.isCompany?te(t):Z(t)}return{sort:f,details:c,rateText:W,isVisible:a,subLength:L,terminate:g,totalColor:d,showReceipt:C,subscriptions:y,clientViewProps:$,activeLeaseCount:q,showCompanyLeaseForm:I,showIndividualLeaseForm:A,smartNavigationTotalFormated:D,writeOff:O,sortFunc:N,changeSort:R,setSubLength:s,setIsVisible:m,closeReceipt:Q,openReciptFor:G,terminateLease:X,closeTerminate:Y,showLeaseFormFor:ae,closeCompanyLeaseForm:se,closeIndividualLeaseForm:ee}}function Le({leases:i,total_pages:j,current_page:p}){const{sort:d,details:c,rateText:r,isVisible:y,subLength:x,terminate:g,totalColor:w,showReceipt:C,subscriptions:_,clientViewProps:L,activeLeaseCount:s,showCompanyLeaseForm:a,showIndividualLeaseForm:m,smartNavigationTotalFormated:f,writeOff:E,sortFunc:$,changeSort:A,setSubLength:T,setIsVisible:I,closeReceipt:P,openReciptFor:F,terminateLease:R,closeTerminate:N,showLeaseFormFor:O,closeCompanyLeaseForm:b,closeIndividualLeaseForm:V}=Ce(i);return e.jsxs(e.Fragment,{children:[e.jsxs(e.Fragment,{children:[e.jsx(Ne,{clientViewProps:L}),e.jsx(J,{position:"top-right"}),m&&e.jsx(re,{action:c?"edit":"add",show:m,handleClose:V,lesseeDetails:c,subscriptionPeriod:c?c.lease_period:x}),a&&e.jsx(ce,{action:c?"edit":"add",show:a,handleClose:b,lesseeDetails:c,subscriptionPeriod:c?c.lease_period:x}),g&&e.jsx(_e,{show:g,handleClose:N,leaseData:c}),C&&e.jsx(le,{show:C,handleClose:P,leaseDetails:c,myKey:"leases"})]}),e.jsxs("main",{id:"hide-footer",children:[e.jsxs("div",{className:"container-xl p-0 mb-5",children:[e.jsx("h5",{className:"bg-info text-center text-white p-2 rounded-2",children:"Lease Management"}),e.jsxs("div",{className:"row justify-content-between align-items-center my-3 g-2",children:[e.jsx("div",{className:"col-5",children:e.jsx(he,{searchBy:"name"})}),e.jsx("div",{className:"col-auto",children:e.jsxs("div",{className:"d-flex border c-bg-light align-items-center",children:[e.jsx("label",{htmlFor:"sort",className:"form-label bg-white c-bg-light d-block my-0 text-nowrap p-1",children:"Sort By:"}),e.jsxs("select",{className:"form-select c-select rounded-0 border",name:"sort",id:"sort",value:d,onChange:A,children:[e.jsx("option",{value:"default",children:"default"}),e.jsx("option",{value:"rent-owing-asc",children:"Rent Owing asc"}),e.jsx("option",{value:"rent-owing-des",children:"Rent Owing des"}),e.jsx("option",{value:"color-asc",children:"color (rent asc)"}),e.jsx("option",{value:"color-des",children:"color (rent des)"})]})]})})]}),e.jsxs("div",{className:"position-relative bg-white rounded-2 border",children:[e.jsxs("h5",{className:"text-center py-2 mb-0 text-white border bg-info",children:["Active Leases - ",s]}),e.jsxs("table",{className:"table table-sm table-responsive table-bordered ",children:[e.jsx("thead",{className:"position-sticky bg-white shadow-sm c-table-top",children:e.jsxs("tr",{children:[e.jsx("th",{className:"ps-3",children:"Lease ID"}),e.jsx("th",{children:"Tenant"}),e.jsx("th",{children:"Customer Number"}),e.jsx("th",{className:"text-end",children:"Rent Owing"}),e.jsx("th",{colSpan:3,className:"text-center",children:"Actions"})]})}),e.jsx("tbody",{children:i?$(i).map((o,D)=>e.jsxs("tr",{className:o.terminated?"c-terminated":"",children:[e.jsx("th",{className:"ps-3",children:o.lease_id||""}),e.jsx("td",{children:e.jsx("button",{title:"double click to view client",type:"button",onDoubleClick:()=>L.openClientView(o),className:`custom-btn text-decoration-underline ${o.terminated?"c-terminated":""}`,children:o.name})}),e.jsx("td",{children:o.customer_number}),e.jsx("td",{className:`bg-${o.color} text-white text-end`,style:{backgroundColor:o.color=="light-red"?"#f87171":""},children:`${o.currency} ${K(o.owing_amount).replace("$","")}`}),e.jsx("td",{className:"bg-info text-white text-center c-pointer",onClick:()=>F(o),children:"Receipt"}),o.terminated?e.jsxs(e.Fragment,{children:[e.jsx("td",{className:"c-terminated text-center",children:"Terminated"}),e.jsx("td",{className:"bg-danger text-white text-center c-pointer",onClick:()=>E(o),children:"Write off"})]}):e.jsxs(e.Fragment,{children:[e.jsx("td",{className:"bg-primary text-white text-center c-pointer",onClick:()=>O(o),children:"Adjust"}),e.jsx("td",{className:"bg-danger text-white text-center c-pointer",onClick:()=>R(o),children:"Terminate"})]})]},o.lease_id+"-"+D)):""}),w&&(i!=null&&i.length)?e.jsx("tfoot",{children:e.jsxs("tr",{children:[e.jsx("td",{className:"border-0 pt-5"}),e.jsxs("td",{className:"border-0 pt-5",children:["Total Debtors: ",i==null?void 0:i.length]}),e.jsx("td",{className:"border-0 pt-5",children:"Total mount"}),e.jsxs("td",{className:"border-0 pt-5 px-0",children:[e.jsx("span",{className:`bg-${w} text-end text-white p-2 w-100 d-inline-block`,style:{backgroundColor:w=="light-red"?"#f87171":w},children:f}),r?e.jsx("small",{className:"d-block text-end p-1 text-muted c-fs-smallest",children:r}):""]}),e.jsx("td",{className:"border-0 pt-5"})]})}):""]}),e.jsx(pe,{currentPage:p,totalPages:j})]})]}),e.jsx("div",{className:"position-fixed w-100 bottom-0 start-0",children:e.jsx(me,{isVisible:y,setIsVisible:I,trigger:e.jsxs("button",{type:"button",className:"btn btn-lg c-bg-warning-light w-100 justify-content-center align-items-center text-capitalize gap-2 ",children:["Available Subscriptions",e.jsx("i",{className:"material-icons fs-3",children:"keyboard_arrow_up"})]}),children:e.jsx(ue,{title:"Available Subscriptions",children:e.jsxs("table",{className:"table table-responsive table-bordered",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"No"}),e.jsx("th",{children:"Type"}),e.jsx("th",{children:"Open Slots"}),e.jsx("th",{children:"Period (months)"}),e.jsx("th",{children:"Start Date"}),e.jsx("th",{children:"End Date"}),e.jsx("th",{})]})}),e.jsx("tbody",{children:_==null?void 0:_.filter(o=>o.open_slots>0).map((o,D)=>e.jsxs("tr",{children:[e.jsx("th",{children:D+1}),e.jsx("td",{children:o.subscription_class}),e.jsx("td",{children:o.open_slots}),e.jsx("td",{children:o.period_length}),e.jsx("td",{children:o.start_date}),e.jsx("td",{children:o.end_date}),e.jsx("td",{className:"bg-success text-white text-center c-pointer",onClick:()=>{O({},{isCompany:o.subscription_class==="company"}),I(!1),T(o.period_left)},children:"Activate"})]},D))})]})})})})]})]})}Le.layout=i=>e.jsx(de,{children:i,title:"Leases"});export{Le as default};

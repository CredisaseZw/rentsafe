import{r as m,a as re,j as e,_ as E,b as P,u as M,d as ie}from"./media/main-603c3784.js";import{d as ce,e as le,R as de,L as me}from"./Layout-af962dee.js";import{M as C}from"./Modal-c85fcfb1.js";import{B as z}from"./Button-fbe2fdbe.js";import{B as ue,D as he}from"./DrawerContent-79d1f144.js";import{P as pe}from"./PaginationControls-18d35d20.js";import{S as xe}from"./SearchBar-ee15c951.js";import{A as fe,D as ge,C as ye,a as be,F as je,P as we}from"./Payments-f7ef4f80.js";import{l as K}from"./lodash-de20a893.js";import{m as J,u as U}from"./index-80d694c0.js";import{f as W}from"./formatting-fad57ba1.js";import"./assertThisInitialized-3be3daa4.js";import"./removeClass-ac4cdc4d.js";import"./index-b312c35d.js";import"./MultipleUpload-ed4b9494.js";import"./search-3ccb72b6.js";import"./index-fc1756e4.js";import"./Button-27afb56f.js";const _e=({show:l,handleClose:g,leaseData:h})=>{const[i,c]=m.useState(!1),{data:r,post:b}=re({leaseId:h.lease_id}),d=()=>{b(reverseUrl("delete_lease"),{onStart:()=>{c(!0)},onSuccess:p=>{E.success(JSON.stringify("Lease terminated successfully")),c(!1)},onError:p=>{E.error("Something went wrong! Please try again"),c(!1)},onFinish:()=>{g()}})};return e.jsxs(C,{show:l,onHide:g,size:"md",backdrop:"static",centered:!0,children:[e.jsx(C.Header,{closeButton:!0,className:"h4 bg-info text-white text-center text-uppercase",children:"Confirm Lease Termination"}),e.jsx(C.Body,{className:"p-4 d-flex justify-content-between align-items-center gap-4",children:e.jsxs("p",{className:"my-3 text-center",children:["Are you sure you want to terninate lease for ",h.name,"? This action cannot be undone."]})}),e.jsxs(C.Footer,{className:"p-4 d-flex justify-content-end gap-4",children:[e.jsxs(z,{onClick:g,variant:"secondary",children:[e.jsx("i",{className:"material-icons",children:"cancel"}),"Cancel"]}),e.jsxs(z,{onClick:d,variant:"danger",children:[e.jsx("i",{className:"material-icons",children:"done"}),"Delete"]})]})]})},Ne=_e;function ve({clientViewProps:{showModal:l,hideClientView:g,data:h,error:i,isLoading:c,clientId:r,refreshClientViewData:b,lease:d}}){const p=!h;return e.jsx(e.Fragment,{children:e.jsxs(C,{show:l,onHide:g,fullscreen:!0,contentClassName:"custom-bg-whitesmoke",children:[e.jsx(C.Header,{className:"p-0",children:e.jsxs("div",{className:"w-100 p-2 text-center bg-info position-relative",children:[e.jsx("h4",{className:"text-white",children:c||i||p?"Client View":h.tenantName}),e.jsx("button",{type:"button",onClick:g,className:"btn position-absolute top-0 end-0 h-100 d-flex align-items-center text-white",children:e.jsx("i",{className:"material-icons fs-3 px-4",children:"close"})})]})}),e.jsx(C.Body,{children:e.jsxs("div",{className:"position-relative custom-mn-h-5",children:[c&&e.jsxs("div",{className:"text-center position-absolute top-50 start-50 translate-middle",children:[e.jsx("div",{className:"spinner-border text-info spinner-border-md",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})}),e.jsx("p",{children:"Loading...please wait"})]}),i&&e.jsxs("div",{className:"text-center text-danger position-absolute top-50 start-50 translate-middle",children:[e.jsx("p",{children:e.jsx("i",{className:"material-icons fs-1",children:"warning"})}),e.jsxs("p",{children:["Error: ",K.truncate(i,{length:500})]})]}),!(c||i||p)&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"row row-cols-3 align-items-stretch",children:[e.jsxs("div",{className:"col p-1",children:[e.jsx(fe,{data:h.agedAnalysis}),e.jsx(ge,{data:h.debtorIntelligence,clientId:r}),e.jsx(ye,{data:h.contactDetails,clientId:r,leaseId:d.lease_id})]}),e.jsx("div",{className:"col p-1",children:e.jsx(be,{messages:h.communicationHistory,clientId:r,lease:d,refresh:b})}),e.jsxs("div",{className:"col p-1",children:[e.jsx(je,{data:h.forecastInflows}),e.jsx(we,{clientId:r,paymentPlans:h.paymentPlans,refreshClientViewData:b,leaseId:d.lease_id,currency:d.currency})]})]})})]})})]})})}function Ce(){const[l,g]=m.useState(!1),[h,i]=m.useState(null),[c,r]=m.useState(""),[b,d]=m.useState(!1),[p,w]=m.useState(null);function L(s,y){if(w(s),g(!0),d(!0),r(""),y){r(y),i(null),d(!1);return}P(reverseUrl("client_details"),{params:{lease_id:s.lease_id}}).then(t=>{const _={tenantName:s.name,agedAnalysis:{oneTwentyDays:t.data.aged_analysis["120_days_plus"],ninetyDays:t.data.aged_analysis["90_days"],sixtyDays:t.data.aged_analysis["60_days"],thirtyDays:t.data.aged_analysis["30_days"],current:t.data.aged_analysis.current},contactDetails:{contactPerson:`${t.data.client.firstname} ${t.data.client.surname}`,smsNumber:t.data.client.sms_number,otherNumbers:t.data.client.other_numbers?t.data.client.other_numbers.join(", "):"",emailAddress:t.data.client.email,address:t.data.client.address},paymentPlans:t.data.payment_plans.map(f=>({id:f.id,person:f.spoke_with,date:f.expected_pay_date,amount:f.amount})),communicationHistory:t.data.communication_history.map(f=>({text:f.message,timestamp:f.created_at,user:f.user_name,actionDone:f.action_done?f.action_done:null,communicationType:f.type,data:null})),debtorIntelligence:Object.values(t.data.debtor_intelligence).length&&Object.values(t.data.debtor_intelligence).every(Boolean)?{text:t.data.debtor_intelligence.note,timestamp:t.data.debtor_intelligence.updated_at,user:t.data.debtor_intelligence.user_name}:null,forecastInflows:{zeroToSevenDays:t.data.forecast_inflows["0-7"],eightToFourteenDays:t.data.forecast_inflows["8-14"],fourteenToTwentyOneDays:t.data.forecast_inflows["14-21"],twentyOnePlusDays:t.data.forecast_inflows["21+"],total:t.data.forecast_inflows.total}};_.communicationHistory=_.communicationHistory.concat(J({works:t.data.works_data||[],maintenance:t.data.maintenance_data||[]})),console.log({res:t,resData:_,lease:s}),i(_),r(""),d(!1)}).catch(t=>{r(U(t)),i(null),d(!1)})}function S(){console.log("refreshing.."),d(!0),r(""),P(reverseUrl("client_details"),{params:{lease_id:p.lease_id}}).then(s=>{const y={tenantName:p.name,agedAnalysis:{oneTwentyDays:s.data.aged_analysis["120_days_plus"],ninetyDays:s.data.aged_analysis["90_days"],sixtyDays:s.data.aged_analysis["60_days"],thirtyDays:s.data.aged_analysis["30_days"],current:s.data.aged_analysis.current},contactDetails:{contactPerson:`${s.data.client.firstname} ${s.data.client.surname}`,smsNumber:s.data.client.sms_number,otherNumbers:s.data.client.other_numbers?s.data.client.other_numbers.join(", "):"",emailAddress:s.data.client.email,address:s.data.client.address},paymentPlans:s.data.payment_plans.map(t=>({id:t.id,person:t.spoke_with,date:t.expected_pay_date,amount:t.amount})),communicationHistory:s.data.communication_history.map(t=>({text:t.message,timestamp:t.created_at,user:t.user_name,actionDone:t.action_done?t.action_done:null,communicationType:t.type,data:null})),debtorIntelligence:Object.values(s.data.debtor_intelligence).length&&Object.values(s.data.debtor_intelligence).every(Boolean)?{text:s.data.debtor_intelligence.note,timestamp:s.data.debtor_intelligence.updated_at,user:s.data.debtor_intelligence.user_name}:null,forecastInflows:{zeroToSevenDays:s.data.forecast_inflows["0-7"],eightToFourteenDays:s.data.forecast_inflows["8-14"],fourteenToTwentyOneDays:s.data.forecast_inflows["14-21"],twentyOnePlusDays:s.data.forecast_inflows["21+"],total:s.data.forecast_inflows.total}};y.communicationHistory=y.communicationHistory.concat(J({works:s.data.works_data||[],maintenance:s.data.maintenance_data||[]})),console.log({res:s,resData:y,lease:p}),i(y),r(""),d(!1)}).catch(s=>{r(U(s)),i(null),d(!1)})}function k(){g(!1)}return{showModal:l,openClientView:L,hideClientView:k,data:h,error:c,isLoading:b,clientId:p?p.id:null,refreshClientViewData:S,lease:p}}function Le(l){const{props:{error:g},url:h}=M();let i=new URL(h).searchParams.get("color");const[c,r]=m.useState({}),[b,d]=m.useState([]),[p,w]=m.useState(!1),[L,S]=m.useState(!1),[k,s]=m.useState(0),[y,t]=m.useState(!1),[_,f]=m.useState(i?"rent-owing-des":"default"),F=Ce(),[$,I]=m.useState(!1),[T,B]=m.useState(!1),D=new URL(M().url).searchParams.get("open_view_for");m.useEffect(()=>{if(!D)return;const a=l.find(n=>n.lease_id==D);a?F.openClientView(a):F.openClientView(a,`Lease with ID '${D}' is not included in your current leases.`)},[D]),m.useEffect(()=>{P.post(reverseUrl("open_subscription")).then(a=>{d(a.data)}).catch(a=>{})},[d,y]);const O=document.getElementById("hide-footer");switch(m.useEffect(()=>(O!==null&&document.getElementById("footer").classList.add("d-none"),()=>{O!==null&&document.getElementById("footer").classList.remove("d-none")}),[O]),i){case"orange":i="warning";break;case"black":i="black";break;case"red":i="red";break;case"green":i="success";break;case"#991b1b":i="danger";break}g&&E.error(U(g));function A(a){f(a.target.value)}let j=a=>a;function R(a){console.log(a),P.post(reverseUrl("write-off"),{lease_id:a.lease_id}).then(n=>{console.log(n),ie.Inertia.reload()}).catch(n=>{console.log(n);const x=n?.response?.data?.errors?JSON.stringify(n.response.data.errors):JSON.stringify(n);E.error(`An error occured:
`+K.truncate(x,{length:200}))})}switch(_){case"rent-owing-asc":j=a=>{const n=[...a];return n.sort((x,u)=>x.owing_amount-u.owing_amount),n};break;case"rent-owing-des":j=a=>{const n=[...a];return n.sort((x,u)=>u.owing_amount-x.owing_amount),n};break;case"color-asc":j=a=>{const n={};a.forEach(u=>{u.color in n?n[u.color].push(u):n[u.color]=[u]});let x=[];return Object.keys(n).forEach(u=>{x=x.concat(n[u].sort((V,H)=>V.owing_amount-H.owing_amount))}),x};break;case"color-des":j=a=>{const n={};a.forEach(u=>{u.color in n?n[u.color].push(u):n[u.color]=[u]});let x=[];return Object.keys(n).forEach(u=>{x=x.concat(n[u].sort((V,H)=>H.owing_amount-V.owing_amount))}),x};break;default:j=a=>a;break}const[N,o]=m.useState({});m.useEffect(()=>{P.get(reverseUrl("rate_setup")).then(a=>{const n=a?.data?.currency_settings;if(!n)throw new Error("failed to fetch currency settings");o(n)}).catch(a=>{console.log(a)})},[]);const v=Object.keys(N).length===0,q=v?"":`${N?.base_currency.toUpperCase()} ${W(l?l.reduce((a,n)=>{let x=n.owing_amount;return n.currency.trim().toLowerCase()!==N?.base_currency.trim().toLowerCase()&&(x=n.owing_amount/N?.current_rate),a+x},0):0).replace("$","")}`,G=!v&&l&&l.find(a=>a.currency.trim().toLowerCase()!=="usd")?`${N.base_currency.toUpperCase()} 1 = ${N.currency.toUpperCase()} ${N.current_rate}`:"",Q=l?.length?l.reduce((a,n)=>n.terminated?a:a+=1,0):0;function X(a){r(a),S(!0)}function Y(){S(!1),r({})}function Z(a){r(a),w(!0)}function ee(){w(!1),r({})}function te(a){r(a),I(!0)}function ae(){r({}),I(!1)}function se(a){r(a),B(!0)}function ne(){r({}),B(!1)}function oe(a,n={isCompany:!1}){a.is_company||n.isCompany?se(a):te(a)}return{sort:_,details:c,rateText:G,isVisible:y,subLength:k,terminate:p,totalColor:i,showReceipt:L,subscriptions:b,clientViewProps:F,activeLeaseCount:Q,showCompanyLeaseForm:T,showIndividualLeaseForm:$,smartNavigationTotalFormated:q,writeOff:R,sortFunc:j,changeSort:A,setSubLength:s,setIsVisible:t,closeReceipt:Y,openReciptFor:X,terminateLease:Z,closeTerminate:ee,showLeaseFormFor:oe,closeCompanyLeaseForm:ne,closeIndividualLeaseForm:ae}}function Se({leases:l,total_pages:g,current_page:h}){const{sort:i,details:c,rateText:r,isVisible:b,subLength:d,terminate:p,totalColor:w,showReceipt:L,subscriptions:S,clientViewProps:k,activeLeaseCount:s,showCompanyLeaseForm:y,showIndividualLeaseForm:t,smartNavigationTotalFormated:_,writeOff:f,sortFunc:F,changeSort:$,setSubLength:I,setIsVisible:T,closeReceipt:B,openReciptFor:D,terminateLease:O,closeTerminate:A,showLeaseFormFor:j,closeCompanyLeaseForm:R,closeIndividualLeaseForm:N}=Le(l);return e.jsxs(e.Fragment,{children:[e.jsxs(e.Fragment,{children:[e.jsx(ve,{clientViewProps:k}),t&&e.jsx(ce,{action:Object.keys(c).length?"edit":"add",show:t,handleClose:N,lesseeDetails:c,subscriptionPeriod:Object.keys(c).length?c.lease_period:d}),y&&e.jsx(le,{action:Object.keys(c).length?"edit":"add",show:y,handleClose:R,lesseeDetails:c,subscriptionPeriod:Object.keys(c).length?c.lease_period:d}),p&&e.jsx(Ne,{show:p,handleClose:A,leaseData:c}),L&&e.jsx(de,{show:L,handleClose:B,leaseDetails:c,myKey:"leases"})]}),e.jsxs("main",{id:"hide-footer",children:[e.jsxs("div",{className:"container-xl p-0 mb-5",children:[e.jsx("h5",{className:"bg-info text-center text-white p-2 rounded-2",children:"Lease Management"}),e.jsxs("div",{className:"position-relative bg-white rounded-2 border",children:[e.jsxs("table",{className:"table table-sm table-responsive table-bordered ",children:[e.jsxs("thead",{className:"position-sticky bg-white shadow-sm c-table-top",children:[e.jsx("tr",{children:e.jsxs("td",{colSpan:7,children:[e.jsxs("div",{className:"row justify-content-between align-items-center my-1",children:[e.jsx("div",{className:"col-5",children:e.jsx(xe,{searchBy:"name"})}),e.jsx("div",{className:"col-auto",children:e.jsxs("div",{className:"d-flex border c-bg-light align-items-center",children:[e.jsx("label",{htmlFor:"sort",className:"form-label bg-white c-bg-light d-block my-0 text-nowrap p-1",children:"Sort By:"}),e.jsxs("select",{className:"form-select c-select rounded-0 border",name:"sort",id:"sort",value:i,onChange:$,children:[e.jsx("option",{value:"default",children:"default"}),e.jsx("option",{value:"rent-owing-asc",children:"Rent Owing asc"}),e.jsx("option",{value:"rent-owing-des",children:"Rent Owing des"}),e.jsx("option",{value:"color-asc",children:"color (rent asc)"}),e.jsx("option",{value:"color-des",children:"color (rent des)"})]})]})})]}),e.jsxs("h5",{className:"text-center py-2 mb-0 text-white border bg-info",children:["Active Leases - ",s]})]})}),e.jsxs("tr",{className:"c-force-borders",children:[e.jsx("th",{className:"ps-3",children:e.jsx("div",{children:"Lease ID"})}),e.jsx("th",{children:e.jsx("div",{children:"Tenant"})}),e.jsx("th",{children:e.jsx("div",{children:"Customer Number"})}),e.jsx("th",{className:"text-end",children:e.jsx("div",{children:"Rent Owing"})}),e.jsx("th",{className:"text-center",colSpan:3,children:e.jsx("div",{children:"Actions"})})]})]}),e.jsx("tbody",{children:l?F(l).map((o,v)=>e.jsxs("tr",{className:o.terminated?"c-terminated":"",children:[e.jsx("th",{className:"ps-3",children:o.lease_id||""}),e.jsx("td",{children:e.jsx("button",{title:"double click to view client",type:"button",onDoubleClick:()=>k.openClientView(o),className:`custom-btn text-decoration-underline ${o.terminated?"c-terminated":""}`,children:o.name})}),e.jsx("td",{children:o.customer_number}),e.jsx("td",{className:`bg-${o.color} text-white text-end`,style:{backgroundColor:o.color=="light-red"?"#f87171":""},children:`${o.currency} ${W(o.owing_amount).replace("$","")}`}),e.jsx("td",{className:"bg-info text-white text-center c-pointer",onClick:()=>D(o),children:"Receipt"}),o.terminated?e.jsxs(e.Fragment,{children:[e.jsx("td",{className:"c-terminated text-center",children:"Terminated"}),e.jsx("td",{className:"bg-danger text-white text-center c-pointer",onClick:()=>f(o),children:"Write off"})]}):e.jsxs(e.Fragment,{children:[e.jsx("td",{className:"bg-primary text-white text-center c-pointer",onClick:()=>j(o),children:"Adjust"}),e.jsx("td",{className:"bg-danger text-white text-center c-pointer",onClick:()=>O(o),children:"Terminate"})]})]},o.lease_id+"-"+v)):""}),w&&l?.length?e.jsx("tfoot",{children:e.jsxs("tr",{children:[e.jsx("td",{className:"border-0 pt-5"}),e.jsxs("td",{className:"border-0 pt-5",children:["Total Debtors: ",l?.length]}),e.jsx("td",{className:"border-0 pt-5",children:"Total mount"}),e.jsxs("td",{className:"border-0 pt-5 px-0",children:[e.jsx("span",{className:`bg-${w} text-end text-white p-2 w-100 d-inline-block`,style:{backgroundColor:w=="light-red"?"#f87171":w},children:_}),r?e.jsx("small",{className:"d-block text-end p-1 text-muted c-fs-smallest",children:r}):""]}),e.jsx("td",{className:"border-0 pt-5"})]})}):""]}),e.jsx(pe,{currentPage:h,totalPages:g})]})]}),e.jsx("div",{className:"position-fixed w-100 bottom-0 start-0",children:e.jsx(ue,{isVisible:b,setIsVisible:T,trigger:e.jsxs("button",{type:"button",className:"btn btn-lg c-bg-warning-light w-100 justify-content-center align-items-center text-capitalize gap-2 ",children:["Available Subscriptions",e.jsx("i",{className:"material-icons fs-3",children:"keyboard_arrow_up"})]}),children:e.jsx(he,{title:"Available Subscriptions",children:e.jsxs("table",{className:"table table-responsive table-bordered",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"No"}),e.jsx("th",{children:"Open Slots"}),e.jsx("th",{children:"Period (months)"}),e.jsx("th",{children:"Start Date"}),e.jsx("th",{children:"End Date"}),e.jsx("th",{})]})}),e.jsx("tbody",{children:S?.filter(o=>o.open_slots>0).map((o,v)=>e.jsxs("tr",{children:[e.jsx("th",{children:v+1}),e.jsx("td",{children:o.open_slots}),e.jsx("td",{children:o.period_length}),e.jsx("td",{children:o.start_date}),e.jsx("td",{children:o.end_date}),e.jsx("td",{className:"bg-success text-white text-center c-pointer",onClick:()=>{j({},{isCompany:!1}),T(!1),I(o.period_left)},children:"Activate Individual"}),e.jsx("td",{className:"bg-info text-white text-center c-pointer",onClick:()=>{j({},{isCompany:!0}),T(!1),I(o.period_left)},children:"Activate Company"})]},v))})]})})})})]})]})}Se.layout=l=>e.jsx(me,{children:l,title:"Leases"});export{Se as default};

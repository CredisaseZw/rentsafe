import{r as m,a as re,j as e,b as S,u as M,d as ie}from"./main-c8b8ea5d.js";import{I as ce,b as le,R as de,L as me}from"./Layout-a1c7470d.js";import{I as J,_ as E}from"./index-7e0c3631.js";import{M as C}from"./Modal-14ec898e.js";import{B as z}from"./Button-3b9ff2fe.js";import{B as ue,D as he}from"./DrawerContent-652948ed.js";import{S as pe,P as xe}from"./PaginationControls-5a367fce.js";import{A as ge,D as fe,C as be,a as je,F as ye,P as we}from"./Payments-2b1e9ace.js";import{l as K,u as H}from"./index-b7f8d1dc.js";import{f as W}from"./formatting-345d2430.js";import"./assertThisInitialized-3be3daa4.js";import"./removeClass-164d94dd.js";import"./MultipleUpload-d227dc90.js";import"./search-0550149b.js";import"./index-41c30b0e.js";import"./Button-14a84d9c.js";const _e=({show:r,handleClose:j,leaseData:x})=>{const[d,c]=m.useState(!1),{data:i,post:y}=re({leaseId:x.lease_id}),u=()=>{y(reverseUrl("delete_lease"),{onStart:()=>{c(!0)},onSuccess:g=>{E.success(JSON.stringify("Lease terminated successfully")),c(!1)},onError:g=>{E.error("Something went wrong! Please try again"),c(!1)},onFinish:()=>{j()}})};return e.jsxs(C,{show:r,onHide:j,size:"md",backdrop:"static",centered:!0,children:[e.jsx(C.Header,{closeButton:!0,className:"h4 bg-info text-white text-center text-uppercase",children:"Confirm Lease Termination"}),e.jsxs(C.Body,{className:"p-4 d-flex justify-content-between align-items-center gap-4",children:[e.jsx(J,{}),e.jsxs("p",{className:"my-3 text-center",children:["Are you sure you want to terninate lease for ",x.name,"? This action cannot be undone."]})]}),e.jsxs(C.Footer,{className:"p-4 d-flex justify-content-end gap-4",children:[e.jsxs(z,{onClick:j,variant:"secondary",children:[e.jsx("i",{className:"material-icons",children:"cancel"}),"Cancel"]}),e.jsxs(z,{onClick:u,variant:"danger",children:[e.jsx("i",{className:"material-icons",children:"done"}),"Delete"]})]})]})},Ne=_e;function ve({clientViewProps:{showModal:r,hideClientView:j,data:x,error:d,isLoading:c,clientId:i,refreshClientViewData:y,lease:u}}){const g=!x;return console.log(u),e.jsx(e.Fragment,{children:e.jsxs(C,{show:r,onHide:j,fullscreen:!0,contentClassName:"custom-bg-whitesmoke",children:[e.jsx(C.Header,{className:"p-0",children:e.jsxs("div",{className:"w-100 p-2 text-center bg-info position-relative",children:[e.jsx("h4",{className:"text-white",children:c||d||g?"Client View":x.tenantName}),e.jsx("button",{type:"button",onClick:j,className:"btn position-absolute top-0 end-0 h-100 d-flex align-items-center text-white",children:e.jsx("i",{className:"material-icons fs-3 px-4",children:"close"})})]})}),e.jsx(C.Body,{children:e.jsxs("div",{className:"position-relative custom-mn-h-5",children:[c&&e.jsxs("div",{className:"text-center position-absolute top-50 start-50 translate-middle",children:[e.jsx("div",{className:"spinner-border text-info spinner-border-md",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})}),e.jsx("p",{children:"Loading...please wait"})]}),d&&e.jsxs("div",{className:"text-center text-danger position-absolute top-50 start-50 translate-middle",children:[e.jsx("p",{children:e.jsx("i",{className:"material-icons fs-1",children:"warning"})}),e.jsxs("p",{children:["Error: ",K.truncate(d,{length:500})]})]}),!(c||d||g)&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"row row-cols-3 align-items-stretch",children:[e.jsxs("div",{className:"col p-1",children:[e.jsx(ge,{data:x.agedAnalysis}),e.jsx(fe,{data:x.debtorIntelligence,clientId:i}),e.jsx(be,{data:x.contactDetails,clientId:i,leaseId:u.lease_id})]}),e.jsx("div",{className:"col p-1",children:e.jsx(je,{messages:x.communicationHistory,clientId:i,lease:u})}),e.jsxs("div",{className:"col p-1",children:[e.jsx(ye,{data:x.forecastInflows}),e.jsx(we,{clientId:i,paymentPlans:x.paymentPlans,refreshClientViewData:y,leaseId:u.lease_id})]})]})})]})})]})})}function Ce(){const[r,j]=m.useState(!1),[x,d]=m.useState(null),[c,i]=m.useState(""),[y,u]=m.useState(!1),[g,w]=m.useState(null);function L(n){w(n),j(!0),u(!0),i(""),S(reverseUrl("client_details"),{params:{lease_id:n.lease_id}}).then(s=>{console.log(s);const h={tenantName:n.name,agedAnalysis:{oneTwentyDays:s.data.aged_analysis["120_days_plus"],ninetyDays:s.data.aged_analysis["90_days"],sixtyDays:s.data.aged_analysis["60_days"],thirtyDays:s.data.aged_analysis["30_days"],current:s.data.aged_analysis.current},contactDetails:{contactPerson:`${s.data.client.firstname} ${s.data.client.surname}`,smsNumber:s.data.client.sms_number,otherNumbers:s.data.other_numbers?s.data.client.other_numbers.join(", "):"",emailAddress:s.data.client.email,address:s.data.client.address},paymentPlans:s.data.payment_plans.map(f=>({id:f.id,person:f.spoke_with,date:f.expected_pay_date,amount:f.amount})),communicationHistory:s.data.communication_history.map(f=>({text:f.message,timestamp:f.created_at,user:f.user_name,actionDone:f.action_done?f.action_done:null,communicationType:f.type})),debtorIntelligence:Object.values(s.data.debtor_intelligence).length&&Object.values(s.data.debtor_intelligence).every(Boolean)?{text:s.data.debtor_intelligence.note,timestamp:s.data.debtor_intelligence.updated_at,user:s.data.debtor_intelligence.user_name}:null,forecastInflows:{zeroToSevenDays:s.data.forecast_inflows["0-7"],eightToFourteenDays:s.data.forecast_inflows["8-14"],fourteenToTwentyOneDays:s.data.forecast_inflows["14-21"],twentyOnePlusDays:s.data.forecast_inflows["21+"],total:s.data.forecast_inflows.total}};console.log({res:s,resData:h}),d(h),i(""),u(!1)}).catch(s=>{i(H(s)),d(null),u(!1)})}function N(){console.log("refreshing.."),u(!0),i(""),S(reverseUrl("client_details"),{params:{lease_id:g.lease_id}}).then(n=>{const s={tenantName:g.name,agedAnalysis:{oneTwentyDays:n.data.aged_analysis["120_days_plus"],ninetyDays:n.data.aged_analysis["90_days"],sixtyDays:n.data.aged_analysis["60_days"],thirtyDays:n.data.aged_analysis["30_days"],current:n.data.aged_analysis.current},contactDetails:{contactPerson:`${n.data.client.firstname} ${n.data.client.surname}`,smsNumber:n.data.client.sms_number,otherNumbers:n.data.client.other_numbers?n.data.client.other_numbers.join(", "):"",emailAddress:n.data.client.email,address:n.data.client.address},paymentPlans:n.data.payment_plans.map(h=>({id:h.id,person:h.spoke_with,date:h.expected_pay_date,amount:h.amount})),communicationHistory:n.data.communication_history.map(h=>({text:h.message,timestamp:h.created_at,user:h.user_name,actionDone:h.action_done?h.action_done:null,communicationType:h.type})),debtorIntelligence:Object.values(n.data.debtor_intelligence).length&&Object.values(n.data.debtor_intelligence).every(Boolean)?{text:n.data.debtor_intelligence.note,timestamp:n.data.debtor_intelligence.updated_at,user:n.data.debtor_intelligence.user_name}:null,forecastInflows:{zeroToSevenDays:n.data.forecast_inflows["0-7"],eightToFourteenDays:n.data.forecast_inflows["8-14"],fourteenToTwentyOneDays:n.data.forecast_inflows["14-21"],twentyOnePlusDays:n.data.forecast_inflows["21+"],total:n.data.forecast_inflows.total}};d(s),i(""),u(!1)}).catch(n=>{i(H(n)),d(null),u(!1)})}function D(){j(!1)}return console.log(g),{showModal:r,openClientView:L,hideClientView:D,data:x,error:c,isLoading:y,clientId:g?g.id:null,refreshClientViewData:N,lease:g}}function Le(r){const{props:{error:j},url:x}=M();let d=new URL(x).searchParams.get("color");const[c,i]=m.useState({}),[y,u]=m.useState([]),[g,w]=m.useState(!1),[L,N]=m.useState(!1),[D,n]=m.useState(0),[s,h]=m.useState(!1),[f,R]=m.useState(d?"rent-owing-des":"default"),I=Ce(),[$,T]=m.useState(!1),[O,P]=m.useState(!1),B=new URL(M().url).searchParams.get("open_view_for");m.useEffect(()=>{const t=r.find(a=>a.lease_id==B);t&&I.openClientView(t)},[B]),m.useEffect(()=>{S.post(reverseUrl("open_subscription")).then(t=>{u(t.data)}).catch(t=>{})},[u]);const k=document.getElementById("hide-footer");switch(m.useEffect(()=>(k!==null&&document.getElementById("footer").classList.add("d-none"),()=>{k!==null&&document.getElementById("footer").classList.remove("d-none")}),[k]),d){case"orange":d="warning";break;case"black":d="black";break;case"red":d="red";break;case"green":d="success";break;case"#991b1b":d="danger";break}j&&E.error(H(j));function A(t){R(t.target.value)}let _=t=>t;function V(t){console.log(t),S.post(reverseUrl("write-off"),{lease_id:t.lease_id}).then(a=>{console.log(a),ie.Inertia.reload()}).catch(a=>{var l,F;console.log(a);const p=(F=(l=a==null?void 0:a.response)==null?void 0:l.data)!=null&&F.errors?JSON.stringify(a.response.data.errors):JSON.stringify(a);E.error(`An error occured:
`+K.truncate(p,{length:200}))})}switch(f){case"rent-owing-asc":_=t=>{const a=[...t];return a.sort((p,l)=>p.owing_amount-l.owing_amount),a};break;case"rent-owing-des":_=t=>{const a=[...t];return a.sort((p,l)=>l.owing_amount-p.owing_amount),a};break;case"color-asc":_=t=>{const a={};t.forEach(l=>{l.color in a?a[l.color].push(l):a[l.color]=[l]});let p=[];return Object.keys(a).forEach(l=>{p=p.concat(a[l].sort((F,U)=>F.owing_amount-U.owing_amount))}),p};break;case"color-des":_=t=>{const a={};t.forEach(l=>{l.color in a?a[l.color].push(l):a[l.color]=[l]});let p=[];return Object.keys(a).forEach(l=>{p=p.concat(a[l].sort((F,U)=>U.owing_amount-F.owing_amount))}),p};break;default:_=t=>t;break}const[b,o]=m.useState({});m.useEffect(()=>{S.get(reverseUrl("rate_setup")).then(t=>{var p;const a=(p=t==null?void 0:t.data)==null?void 0:p.currency_settings;if(!a)throw new Error("failed to fetch currency settings");o(a)}).catch(t=>{console.log(t)})},[]);const v=Object.keys(b).length===0,q=v?"":`${b==null?void 0:b.base_currency.toUpperCase()} ${W(r?r.reduce((t,a)=>{let p=a.owing_amount;return a.currency.trim().toLowerCase()!==(b==null?void 0:b.base_currency.trim().toLowerCase())&&(p=a.owing_amount/(b==null?void 0:b.current_rate)),t+p},0):0).replace("$","")}`,G=!v&&r&&r.find(t=>t.currency.trim().toLowerCase()!=="usd")?`${b.base_currency.toUpperCase()} 1 = ${b.currency.toUpperCase()} ${b.current_rate}`:"",Q=r!=null&&r.length?r.reduce((t,a)=>a.terminated?t:t+=1,0):0;function X(t){i(t),N(!0)}function Y(){N(!1),i({})}function Z(t){i(t),w(!0)}function ee(){w(!1),i({})}function te(t){i(t),T(!0)}function ae(){i({}),T(!1)}function se(t){i(t),P(!0)}function ne(){i({}),P(!1)}function oe(t,a={isCompany:!1}){t.is_company||a.isCompany?se(t):te(t)}return{sort:f,details:c,rateText:G,isVisible:s,subLength:D,terminate:g,totalColor:d,showReceipt:L,subscriptions:y,clientViewProps:I,activeLeaseCount:Q,showCompanyLeaseForm:O,showIndividualLeaseForm:$,smartNavigationTotalFormated:q,writeOff:V,sortFunc:_,changeSort:A,setSubLength:n,setIsVisible:h,closeReceipt:Y,openReciptFor:X,terminateLease:Z,closeTerminate:ee,showLeaseFormFor:oe,closeCompanyLeaseForm:ne,closeIndividualLeaseForm:ae}}function De({leases:r,total_pages:j,current_page:x}){const{sort:d,details:c,rateText:i,isVisible:y,subLength:u,terminate:g,totalColor:w,showReceipt:L,subscriptions:N,clientViewProps:D,activeLeaseCount:n,showCompanyLeaseForm:s,showIndividualLeaseForm:h,smartNavigationTotalFormated:f,writeOff:R,sortFunc:I,changeSort:$,setSubLength:T,setIsVisible:O,closeReceipt:P,openReciptFor:B,terminateLease:k,closeTerminate:A,showLeaseFormFor:_,closeCompanyLeaseForm:V,closeIndividualLeaseForm:b}=Le(r);return e.jsxs(e.Fragment,{children:[e.jsxs(e.Fragment,{children:[e.jsx(ve,{clientViewProps:D}),e.jsx(J,{position:"top-right"}),h&&e.jsx(ce,{action:Object.keys(c).length?"edit":"add",show:h,handleClose:b,lesseeDetails:c,subscriptionPeriod:Object.keys(c).length?c.lease_period:u}),s&&e.jsx(le,{action:Object.keys(c).length?"edit":"add",show:s,handleClose:V,lesseeDetails:c,subscriptionPeriod:Object.keys(c).length?c.lease_period:u}),g&&e.jsx(Ne,{show:g,handleClose:A,leaseData:c}),L&&e.jsx(de,{show:L,handleClose:P,leaseDetails:c,myKey:"leases"})]}),e.jsxs("main",{id:"hide-footer",children:[e.jsxs("div",{className:"container-xl p-0 mb-5",children:[e.jsx("h5",{className:"bg-info text-center text-white p-2 rounded-2",children:"Lease Management"}),e.jsxs("div",{className:"row justify-content-between align-items-center my-3 g-2",children:[e.jsx("div",{className:"col-5",children:e.jsx(pe,{searchBy:"name"})}),e.jsx("div",{className:"col-auto",children:e.jsxs("div",{className:"d-flex border c-bg-light align-items-center",children:[e.jsx("label",{htmlFor:"sort",className:"form-label bg-white c-bg-light d-block my-0 text-nowrap p-1",children:"Sort By:"}),e.jsxs("select",{className:"form-select c-select rounded-0 border",name:"sort",id:"sort",value:d,onChange:$,children:[e.jsx("option",{value:"default",children:"default"}),e.jsx("option",{value:"rent-owing-asc",children:"Rent Owing asc"}),e.jsx("option",{value:"rent-owing-des",children:"Rent Owing des"}),e.jsx("option",{value:"color-asc",children:"color (rent asc)"}),e.jsx("option",{value:"color-des",children:"color (rent des)"})]})]})})]}),e.jsxs("div",{className:"position-relative bg-white rounded-2 border",children:[e.jsxs("h5",{className:"text-center py-2 mb-0 text-white border bg-info",children:["Active Leases - ",n]}),e.jsxs("table",{className:"table table-sm table-responsive table-bordered ",children:[e.jsx("thead",{className:"position-sticky bg-white shadow-sm c-table-top",children:e.jsxs("tr",{children:[e.jsx("th",{className:"ps-3",children:"Lease ID"}),e.jsx("th",{children:"Tenant"}),e.jsx("th",{children:"Customer Number"}),e.jsx("th",{className:"text-end",children:"Rent Owing"}),e.jsx("th",{colSpan:3,className:"text-center",children:"Actions"})]})}),e.jsx("tbody",{children:r?I(r).map((o,v)=>e.jsxs("tr",{className:o.terminated?"c-terminated":"",children:[e.jsx("th",{className:"ps-3",children:o.lease_id||""}),e.jsx("td",{children:e.jsx("button",{title:"double click to view client",type:"button",onDoubleClick:()=>D.openClientView(o),className:`custom-btn text-decoration-underline ${o.terminated?"c-terminated":""}`,children:o.name})}),e.jsx("td",{children:o.customer_number}),e.jsx("td",{className:`bg-${o.color} text-white text-end`,style:{backgroundColor:o.color=="light-red"?"#f87171":""},children:`${o.currency} ${W(o.owing_amount).replace("$","")}`}),e.jsx("td",{className:"bg-info text-white text-center c-pointer",onClick:()=>B(o),children:"Receipt"}),o.terminated?e.jsxs(e.Fragment,{children:[e.jsx("td",{className:"c-terminated text-center",children:"Terminated"}),e.jsx("td",{className:"bg-danger text-white text-center c-pointer",onClick:()=>R(o),children:"Write off"})]}):e.jsxs(e.Fragment,{children:[e.jsx("td",{className:"bg-primary text-white text-center c-pointer",onClick:()=>_(o),children:"Adjust"}),e.jsx("td",{className:"bg-danger text-white text-center c-pointer",onClick:()=>k(o),children:"Terminate"})]})]},o.lease_id+"-"+v)):""}),w&&(r!=null&&r.length)?e.jsx("tfoot",{children:e.jsxs("tr",{children:[e.jsx("td",{className:"border-0 pt-5"}),e.jsxs("td",{className:"border-0 pt-5",children:["Total Debtors: ",r==null?void 0:r.length]}),e.jsx("td",{className:"border-0 pt-5",children:"Total mount"}),e.jsxs("td",{className:"border-0 pt-5 px-0",children:[e.jsx("span",{className:`bg-${w} text-end text-white p-2 w-100 d-inline-block`,style:{backgroundColor:w=="light-red"?"#f87171":w},children:f}),i?e.jsx("small",{className:"d-block text-end p-1 text-muted c-fs-smallest",children:i}):""]}),e.jsx("td",{className:"border-0 pt-5"})]})}):""]}),e.jsx(xe,{currentPage:x,totalPages:j})]})]}),e.jsx("div",{className:"position-fixed w-100 bottom-0 start-0",children:e.jsx(ue,{isVisible:y,setIsVisible:O,trigger:e.jsxs("button",{type:"button",className:"btn btn-lg c-bg-warning-light w-100 justify-content-center align-items-center text-capitalize gap-2 ",children:["Available Subscriptions",e.jsx("i",{className:"material-icons fs-3",children:"keyboard_arrow_up"})]}),children:e.jsx(he,{title:"Available Subscriptions",children:e.jsxs("table",{className:"table table-responsive table-bordered",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"No"}),e.jsx("th",{children:"Type"}),e.jsx("th",{children:"Open Slots"}),e.jsx("th",{children:"Period (months)"}),e.jsx("th",{children:"Start Date"}),e.jsx("th",{children:"End Date"}),e.jsx("th",{})]})}),e.jsx("tbody",{children:N==null?void 0:N.filter(o=>o.open_slots>0).map((o,v)=>e.jsxs("tr",{children:[e.jsx("th",{children:v+1}),e.jsx("td",{children:o.subscription_class}),e.jsx("td",{children:o.open_slots}),e.jsx("td",{children:o.period_length}),e.jsx("td",{children:o.start_date}),e.jsx("td",{children:o.end_date}),e.jsx("td",{className:"bg-success text-white text-center c-pointer",onClick:()=>{_({},{isCompany:o.subscription_class==="company"}),O(!1),T(o.period_left)},children:"Activate"})]},v))})]})})})})]})]})}De.layout=r=>e.jsx(me,{children:r,title:"Leases"});export{De as default};

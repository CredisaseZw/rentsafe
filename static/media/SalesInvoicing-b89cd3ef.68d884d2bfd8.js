import{r as h,j as e,R as S,b as F,_ as w,u as X,d as H}from"./main-fd1dbebb.js";import{C as W,I as Z,L as ee}from"./Layout-7d6b92ff.js";import{S as te}from"./SearchBar-8740523e.js";import{u as k,f as B}from"./index-cf4ac53f.js";import{U as se}from"./UserSelector-91febc0e.js";import{u as ne,c as ae}from"./Modal-d83c389c.js";import"./lodash-1fb00506.js";import"./assertThisInitialized-3be3daa4.js";import"./removeClass-ca95e0eb.js";import"./formatting-fad57ba1.js";import"./MultipleUpload-3d28a641.js";import"./search-0091414d.js";import"./index-6b877c29.js";const $=h.forwardRef(({bsPrefix:t,variant:l,animation:r="border",size:c,as:u="div",className:n,...x},o)=>{t=ne(t,"spinner");const f=`${t}-${r}`;return e.jsx(u,{ref:o,...x,className:ae(n,f,c&&`${f}-${c}`,l&&`text-${l}`)})});$.displayName="Spinner";const re=$;function le(){const[t,l]=S.useState([]),[r,c]=S.useState(!1);function u(){c(!0),F.get("/accounting/currency").then(n=>{l(n.data)}).catch(n=>{console.log(n)}).finally(()=>{c(!1)})}return S.useEffect(()=>{u()},[]),{loading:r,currencies:t}}function ce(t,l,r){const[c,u]=h.useState(null),[n,x]=h.useState(!1),[o,f]=h.useState(!1),[p,N]=h.useState([]),[T,b]=h.useState([]),[m,d]=h.useState(0),[j,D]=h.useState(0),[V,L]=h.useState(null),{currencies:g,loading:A}=le(),[v,y]=h.useState([{static:!1,sales_code:"",sales_item:"",price:"",qty:"",vat:"",total:""}]);h.useEffect(()=>{g.length>0&&!V&&L(g[0])},[g.length]),h.useEffect(()=>{if(t){const s={document_number:t.document_number,bill_to:t.bill_to,address:t.address,phone:t.phone,email:t.email,vat_no:t.vat_no,tin:t.tin,currency:t.currency,monthly_rental:t.monthly_rental};u(s);const a=g.find(i=>i.id==s.currency||String(i.currency_code).toLowerCase().includes(String(s.currency).toLowerCase()));a?L(a):w.error("could not auto-set invoice currency"),y([s.monthly_rental])}},[t]),h.useEffect(()=>{q(),E()},[]);function q(){F.get("/accounting/items/").then(s=>{N(s.data)}).catch(s=>{console.log(s)})}function E(){F.get("/accounting/vat-settings/").then(s=>{b(s.data)}).catch(s=>{console.error(s)})}function _(){y([...v,{static:!1,sales_code:"",sales_item:"",price:"",qty:"",vat:"",total:""}])}function I(s){const a=v.filter((i,C)=>C!==s);y(a)}function Y(){f(!0)}function J(){f(!1)}function z(s){if(s.preventDefault(),!v.length){w.error("Please add at least one item");return}const a=Object.fromEntries(new FormData(s.target).entries());a.items=v.map(i=>({sales_item_id:p.find(R=>R.name=i.sales_item)?.id||"",qty:i.qty||1,price:i.price})),Object.keys(O).forEach(i=>a[i]=O[i]),a.invoiceTotal+=Number(j),a.discount=Number(j),a.invoice_type=l?"proforma":t?"recurring":"fiscal",a.is_individual=a.customer_type==="INDIVIDUAL",F.post("/accounting/invoices/",a).then(i=>{console.log(i),i.status===201?(w.success(k("Invoice created successfully")),y([{static:!1,sales_code:"",sales_item:"",price:"",qty:"",vat:"",total:""}]),D(0),d(C=>C+1),f(!1),r&&r()):w.error(k(i))}).catch(i=>{console.error(i),w.error(k(i))})}function G(s){y([{sales_code:"",sales_item:"",price:"",qty:"",vat:"",total:""}]);const a=g.find(i=>i.id==s.target.value);a?(L(a),d(i=>i+1)):w.error("error selecting currency")}const O=v?.reduce((s,a)=>{if(!a)return s;const i=parseFloat(a.qty)||0,C=(parseFloat(a.vat)||0)/100,R=parseFloat(a.price)||0;return s.totalExcludingVat+=R*i,s.vatTotal+=R*C*i,s.invoiceTotal+=parseFloat(a.total)||0,s},{totalExcludingVat:0,vatTotal:0,invoiceTotal:0});function K(s){let a=parseFloat(s.target.value)||0;a>0?w.error("Discount should be input as a negative value"):D(a)}function Q(s){const a={address:s.address,phone:s.mobile,email:s.email,vat_no:s.VAT_number,tin:s.tin_number};u(a)}return{key:m,show:o,items:v,totals:O,discount:j,salesItems:p,currencies:g,taxConfigs:T,invoiceData:c,selectedCurrency:V,isLoading:n||A,addRow:_,setItems:y,onSubmit:z,removeRow:I,handleShow:Y,handleClose:J,changeCurrency:G,handleDiscount:K,handleUserSelected:Q}}function U({invoice:t,triggerClassname:l,triggerChildren:r,isProforma:c,onClose:u}){const{key:n,show:x,items:o,totals:f,discount:p,isLoading:N,salesItems:T,currencies:b,taxConfigs:m,invoiceData:d,selectedCurrency:j,addRow:D,setItems:V,onSubmit:L,removeRow:g,handleShow:A,handleClose:v,changeCurrency:y,handleDiscount:q,handleUserSelected:E}=ce(t,c,u);return e.jsxs(e.Fragment,{children:[e.jsx("button",{className:l||"btn btn-info text-white",onClick:A,children:r||e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"leading-icon material-icons",children:"add"}),"New"]})}),e.jsx(W,{size:"xl",show:x,handleClose:v,title:c?"PROFORMA":"FISCAL TAX INVOICE",children:e.jsxs("form",{className:"py-3 position-relative",onSubmit:L,children:[e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"row row-cols-2 pb-3 text-nowrap",children:[e.jsxs("div",{className:"col",children:[e.jsxs("div",{className:"mb-3 d-flex gap-4 align-items-center",children:[e.jsx("label",{htmlFor:"document_number",className:"form-label",children:"Document Number:"}),e.jsx("input",{className:"form-control form-control-sm border-0 border-bottom flex-fill border-3 ",required:!0,name:"document_number",id:"document_number",placeholder:"e.g 112108",readOnly:!!d?.document_number,defaultValue:d?.document_number})]}),e.jsxs("div",{className:"mb-3 d-flex gap-4 align-items-center justify-content-between",children:[e.jsx("label",{htmlFor:"bill_to",className:"form-label",children:"Bill To:"}),d?.bill_to?e.jsx("input",{className:"form-control form-control-sm border-0 border-bottom flex-fill border-3 ",name:"customer_id",id:"customer_id",readOnly:!0,value:d?.bill_to}):e.jsx(se,{onChange:E})]}),e.jsxs("div",{className:"mb-3 d-flex gap-4 align-items-center",children:[e.jsx("label",{htmlFor:"address",className:"form-label",children:"Address:"}),e.jsx("input",{className:"form-control form-control-sm border-0 border-bottom flex-fill border-3 ",required:!0,name:"address",id:"address",placeholder:"Address...",defaultValue:d?.address,readOnly:!!d?.address})]}),e.jsxs("div",{className:"mb-3 d-flex gap-4 align-items-center",children:[e.jsx("label",{htmlFor:"phone",className:"form-label",children:"Phone:"}),e.jsx("input",{className:"form-control form-control-sm border-0 border-bottom flex-fill border-3 ",required:!0,name:"phone",id:"phone",placeholder:"Phone...",defaultValue:d?.phone,readOnly:!!d?.phone})]})]}),e.jsxs("div",{className:"col",children:[e.jsxs("div",{className:"mb-3 d-flex gap-4 align-items-center",children:[e.jsx("label",{htmlFor:"email",className:"form-label",children:"Email:"}),e.jsx("input",{className:"form-control form-control-sm border-0 border-bottom flex-fill border-3 ",required:!0,name:"email",id:"email",placeholder:"Email...",defaultValue:d?.email,readOnly:!!d?.email})]}),e.jsxs("div",{className:"mb-3 d-flex gap-4 align-items-center",children:[e.jsx("label",{htmlFor:"vat_no",className:"form-label",children:"VAT No.:"}),e.jsx("input",{className:"form-control form-control-sm border-0 border-bottom flex-fill border-3 ",required:!0,name:"vat_no",id:"vat_no",placeholder:"VAT No....",defaultValue:d?.vat_no,readOnly:!!d?.vat_no})]}),e.jsxs("div",{className:"mb-3 d-flex gap-4 align-items-center",children:[e.jsx("label",{htmlFor:"tin",className:"form-label",children:"TIN:"}),e.jsx("input",{className:"form-control form-control-sm border-0 border-bottom flex-fill border-3 ",required:!0,name:"tin",id:"tin",placeholder:"TIN...",defaultValue:d?.tin,readOnly:!!d?.tin})]}),e.jsxs("div",{className:"mb-3 d-flex gap-4 align-items-center",children:[e.jsx("label",{htmlFor:"date",className:"form-label",children:"Date:"}),e.jsx("input",{className:"form-control form-control-sm border-0 border-bottom flex-fill border-3 ",required:!0,name:"date",defaultValue:new Date().toISOString().split("T")[0],max:new Date().toISOString().split("T")[0],min:new Date(new Date().setDate(1)).toISOString().split("T")[0],id:"date",type:"date",readOnly:!!d})]})]})]}),e.jsxs("table",{className:"table table-sm table-bordered table-responsive",children:[e.jsxs("thead",{className:"text-center text-nowrap",children:[e.jsxs("tr",{children:[e.jsx("th",{}),e.jsx("th",{}),e.jsx("th",{}),e.jsx("th",{colSpan:2,className:"text-danger",children:"Currency"}),e.jsx("th",{colSpan:2,className:"",children:e.jsx("div",{children:e.jsx("select",{className:"bg-danger text-white py-2 px-4 rounded-3",value:j?.id||"",name:"currency_id",id:"currency_id",onChange:y,children:d?.currency?e.jsx("option",{value:d.currency,children:d.currency}):e.jsxs(e.Fragment,{children:[e.jsx("option",{disabled:!0,value:"",children:"Select Currency"}),b?.map((_,I)=>e.jsxs("option",{value:_.id,children:[_.currency_code," (",_.currency_name,")"]},I))]})})})})]}),e.jsxs("tr",{children:[e.jsx("th",{}),e.jsx("th",{children:"Sales Item"}),e.jsx("th",{children:"Sales Code"}),e.jsx("th",{children:"Price (Vat Inc)"}),e.jsx("th",{children:"QTY"}),e.jsx("th",{children:"VAT"}),e.jsx("th",{children:"Total (Vat Inc)"})]})]}),e.jsx("tbody",{children:o.map((_,I)=>e.jsx(Z,{item:_,index:I,setItems:V,removeRow:g,salesItems:T,taxConfigs:m,selectedCurrency:j,itemsLength:o.length},I+"-"+n))}),e.jsxs("tfoot",{className:"text-end",children:[e.jsxs("tr",{children:[e.jsx("td",{}),e.jsx("td",{colSpan:5,children:e.jsxs("div",{className:"w-100 gap-3 align-items-center d-flex justify-content-between",children:[e.jsxs("button",{type:"button",className:"btn btn-sm btn-outline-info",onClick:D,children:[e.jsx("i",{className:"leading-icon material-icons",children:"add"}),"Add Row"]}),"Total (Excluding VAT)"]})}),e.jsx("td",{children:e.jsx("span",{children:f.totalExcludingVat.toFixed(2)})})]}),e.jsxs("tr",{children:[e.jsx("td",{}),e.jsx("td",{colSpan:5,children:"Discount"}),e.jsx("td",{children:e.jsx("input",{style:{width:"150px"},className:"form-control form-control-sm d-inline-block text-end",type:"number",name:"discount",id:"discount",vlaue:p,max:0,step:.001,onChange:q})})]}),e.jsxs("tr",{children:[e.jsx("td",{}),e.jsx("td",{colSpan:5,children:"VAT Total"}),e.jsx("td",{children:f.vatTotal.toFixed(2)})]}),e.jsxs("tr",{children:[e.jsx("td",{}),e.jsxs("td",{colSpan:5,children:["Invoice Total ",j?.currency_code||""]}),e.jsx("td",{children:(f.invoiceTotal+p).toFixed(2)})]})]})]})]}),e.jsx("div",{className:"text-end",children:e.jsx("button",{className:"btn btn-info text-white",children:"Submit"})}),N&&e.jsx("div",{className:"position-absolute top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center text-center bg-white bg-opacity-75",children:e.jsx(re,{className:"mb-5"})})]})})]})}function ie(t){const[l,r]=S.useState([]),[c,u]=S.useState(!1);function n(){u(!0);const x=t?"proforma-invoices/":"fiscal-invoices/";F.get("/accounting/invoices/"+x).then(o=>{r(o.data),u(!1)}).catch(o=>{console.log(o),u(!1)})}return S.useEffect(()=>{n()},[]),{loading:c,invoiceList:l,reloadInvoices:n}}function oe(t){const[l,r]=h.useState([]),{loading:c,invoiceList:u,reloadInvoices:n}=ie(t),{url:x}=X(),o=new URL(x).searchParams,f=o.get("year"),p=o.get("month"),N=o.get("invoice");h.useEffect(()=>{if(!u.length)return;const b=u.map(m=>({date:m.date_created?new Date(m.date_created):null,invoice:m})).filter(m=>N?`${m.invoice.customer_details?.full_name}###${m.invoice.id}###${m.invoice.currency?.currency_code}`.toLowerCase().includes(N.toLowerCase()):!0).filter(m=>m.date&&f?m.date.getFullYear()===Number(f):!0).filter(m=>m.date&&p?m.date.getMonth()+1===Number(p):!0).map(m=>m.invoice);r(b)},[f,p,N,u.length]);function T(b){b.preventDefault();const m=b.target.year.value,d=b.target.month.value,j=new URL(x);j.searchParams.set("year",m),j.searchParams.set("month",d),H.Inertia.replace(j.href,{preserveState:!0})}return{loading:c,invoiceList:l,applyFilters:T,reloadInvoices:n}}function M({isProforma:t=!1}){const{loading:l,invoiceList:r,applyFilters:c,reloadInvoices:u}=oe(t);return e.jsxs("div",{children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center gap-4 mb-5",children:[e.jsxs("form",{onSubmit:c,className:"d-flex border  gap-2 align-items-center",children:[e.jsx("select",{className:"form-select",name:"year",id:"year",required:!0,defaultValue:new Date().getFullYear(),children:new Array(new Date().getFullYear()-2020).fill(0).map((n,x)=>e.jsx("option",{value:new Date().getFullYear()-x,children:new Date().getFullYear()-x},x))}),e.jsxs("select",{className:"form-select",name:"month",id:"month",required:!0,defaultValue:(new Date().getMonth()+1).toString(),children:[e.jsx("option",{value:"1",children:"January"}),e.jsx("option",{value:"2",children:"February"}),e.jsx("option",{value:"3",children:"March"}),e.jsx("option",{value:"4",children:"April"}),e.jsx("option",{value:"5",children:"May"}),e.jsx("option",{value:"6",children:"June"}),e.jsx("option",{value:"7",children:"July"}),e.jsx("option",{value:"8",children:"August"}),e.jsx("option",{value:"9",children:"September"}),e.jsx("option",{value:"10",children:"October"}),e.jsx("option",{value:"11",children:"November"}),e.jsx("option",{value:"12",children:"December"})]}),e.jsx("div",{children:e.jsx("button",{type:"submit",className:"btn btn-success text-nowrap",children:"Apply Filter"})})]}),e.jsx("div",{className:"custom-mx-w-4",children:e.jsx(te,{placeholder:"Search...",searchBy:"invoice"})})]}),e.jsxs("div",{children:[e.jsxs("h5",{className:"position-relative text-center mb-2 p-2 mb-0",children:[t?"Proforma":""," Invoice List",e.jsx("div",{className:"position-absolute top-0 end-0",children:e.jsx(U,{isProforma:t,onClose:u})})]}),e.jsxs("table",{className:"table table-sm table-bordered table-responsive bg-white",children:[e.jsx("thead",{className:"position-sticky c-table-top text-white bg-info shadow-sm c-z-5",children:e.jsxs("tr",{children:[e.jsx("th",{className:"ps-3",children:"Inv. #"}),e.jsx("th",{children:"Date Created"}),e.jsx("th",{children:"Customer"}),e.jsx("th",{children:"Currency"}),e.jsx("th",{className:"text-end",children:"Invoice Total"}),e.jsx("th",{})]})}),e.jsx("tbody",{children:l?e.jsx("tr",{children:e.jsx("td",{colSpan:6,children:e.jsx("div",{className:"custom-h-3 bg-white d-flex justify-content-center align-items-center",children:e.jsx("div",{className:"spinner-border text-info",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})})})})}):r?.length?r?.map((n,x)=>e.jsxs("tr",{children:[e.jsx("td",{className:"ps-3",children:n.id}),e.jsx("td",{className:"ps-3",children:n.date_created&&B(n.date_created)}),e.jsx("td",{className:"ps-3",children:n.customer_details.full_name}),e.jsx("td",{className:"ps-3",children:n.currency.currency_code}),e.jsx("td",{className:"ps-3 text-end",children:n.total_inclusive&&!Number.isNaN(Number(n.total_inclusive))?Number(n.total_inclusive).toFixed(2):""}),e.jsx("td",{className:"d-flex justify-content-center align-items-center p-1",children:e.jsx("button",{disabled:!0,className:"btn btn-sm w-100 justify-content-center btn-info text-white",children:"View"})})]},x)):e.jsx("tr",{children:e.jsx("td",{colSpan:6,children:e.jsx("div",{className:"custom-h-2 bg-white d-flex justify-content-center align-items-center",children:"Nothing to show"})})})})]})]})]})}function de(){const[t,l]=h.useState(!1),[r,c]=h.useState();function u(){l(!0),F.get("/accounting/invoices/recurring-invoices/").then(n=>{console.log(n);const x=n.data.map(o=>({id:o.id,date_created:B(new Date),customer_acc:"",customer:o.tenant_name,document_number:"",bill_to:o.tenant_name,address:o.address,phone:"",email:"",vat_no:"",tin:"",currency:o.lease_currency_type,monthly_rental:{static:!0,sales_code:"",sales_item:`"Rent - ${o.payment_period_start} ${new Date().getMonth()+1}`,price:o.owing_amount,qty:1,vat_id:"",total:o.owing_amount}}));c(x)}).catch(console.log).finally(()=>l(!1))}return h.useEffect(()=>{u()},[]),{loading:t,invoiceList:r}}function me(){const{loading:t,invoiceList:l}=de();return e.jsx("div",{children:e.jsx("div",{children:e.jsxs("table",{className:"table table-sm table-bordered table-responsive bg-white",children:[e.jsxs("thead",{className:"position-sticky c-table-top shadow-sm bg-white c-z-5",children:[e.jsx("tr",{children:e.jsx("th",{colSpan:6,className:"p-0",children:e.jsx("div",{className:" bg-danger text-white text-center p-2",children:"Recurring Invoices"})})}),e.jsxs("tr",{children:[e.jsx("th",{className:"ps-3",children:"Inv. #"}),e.jsx("th",{children:"Invoice Date"}),e.jsx("th",{children:"Customer Acc"}),e.jsx("th",{children:"Customer Name"}),e.jsx("th",{}),e.jsx("th",{})]})]}),e.jsx("tbody",{children:t?e.jsx("tr",{children:e.jsx("td",{colSpan:6,children:e.jsx("div",{className:"custom-h-2 bg-white d-flex justify-content-center align-items-center",children:e.jsx("div",{className:"spinner-border text-info",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})})})})}):l?.length?l?.map((r,c)=>e.jsxs("tr",{children:[e.jsx("td",{className:"ps-3",children:r.id}),e.jsx("td",{className:"ps-3",children:r.date_created&&B(r.date_created)}),e.jsx("td",{className:"ps-3",children:r.customer_acc||""}),e.jsx("td",{className:"ps-3",children:r.customer}),e.jsx("td",{className:"p-0 ",children:e.jsx("div",{className:"d-flex justify-content-center align-items-center p-1",children:e.jsx(U,{invoice:r,triggerChildren:"Generate",triggerClassname:"btn btn-sm w-100  justify-content-center btn-danger"})})}),e.jsx("td",{className:"p-0",children:e.jsx("div",{className:"d-flex justify-content-center align-items-center p-1",children:e.jsx("button",{className:"btn btn-sm w-100 justify-content-center btn-dark text-white",children:e.jsx("span",{children:"-"})})})})]},c)):e.jsx("tr",{children:e.jsx("td",{colSpan:6,children:e.jsx("div",{className:"custom-h-2 bg-white d-flex justify-content-center align-items-center",children:"Nothing to show"})})})})]})})})}function ue(){return e.jsx(M,{isProforma:!0})}const P=[{key:"Invoice",Content:M},{key:"Recurring",Content:me},{key:"Proforma",Content:ue}];function he(){const[t,l]=S.useState(P[0]);return{tabs:P,activeTab:t,setActiveTab:l}}function xe(){const{tabs:t,activeTab:l,setActiveTab:r}=he();return e.jsxs("div",{children:[e.jsx("div",{className:"d-flex gap-2 mb-3",children:t.map(c=>e.jsx("button",{onClick:()=>r(c),className:`btn ${l===c?"btn-info text-white":"border border-2"}`,children:c.key},c.key))}),e.jsx("div",{children:e.jsx(l.Content,{})})]})}xe.layout=t=>e.jsx(ee,{children:t,title:"Sales Invoicing"});export{xe as default};
